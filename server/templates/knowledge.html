<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“ç®¡ç†</title>
    <!-- æ·»åŠ Socket.IOå®¢æˆ·ç«¯åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .stats-container {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .stats-item {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .back-btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 0 auto;
            text-align: center;
            text-decoration: none;
            width: 150px;
        }
        
        .back-btn:hover {
            background: #0069d9;
            transform: translateY(-2px);
        }
        
        /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .connection-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* PDFä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            margin-top: 20px;
        }
        
        .pdf-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-button {
            display: block;
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .file-input-button:hover {
            background: #0069d9;
        }
        
        .file-name {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .upload-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            grid-column: span 2;
            margin-top: 10px;
        }
        
        .upload-btn:hover {
            background: #0069d9;
            transform: translateY(-2px);
        }
        
        .upload-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* æ–‡æ¡£åˆ—è¡¨ */
        .document-list {
            margin-top: 20px;
        }
        
        .document-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #007bff;
        }
        
        .document-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .document-meta {
            font-size: 12px;
            color: #666;
        }
        
        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            .pdf-form {
                grid-template-columns: 1fr;
            }
            
            .upload-btn {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š çŸ¥è¯†åº“ç®¡ç†</h1>
        
        <div id="connectionStatus" class="connection-status">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
        
        <div class="section">
            <div class="section-title">çŸ¥è¯†åº“ç»Ÿè®¡ä¿¡æ¯</div>
            <div id="knowledgeStats" class="stats-container">
                <div class="stats-item">æ­£åœ¨åŠ è½½ç»Ÿè®¡ä¿¡æ¯...</div>
            </div>
        </div>
        
        <div class="section upload-section">
            <div class="section-title">ä¸Šä¼ PDFæ–‡æ¡£</div>
            <p>å°†PDFæ–‡æ¡£ä¸Šä¼ åˆ°çŸ¥è¯†åº“ä¸­ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–æ–‡æœ¬å¹¶å»ºç«‹ç´¢å¼•ã€‚</p>
            
            <form id="pdfUploadForm" class="pdf-form">
                <div class="form-group">
                    <label for="pdfFile">é€‰æ‹©PDFæ–‡ä»¶</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-button">é€‰æ‹©æ–‡ä»¶</div>
                        <input type="file" id="pdfFile" name="file" accept=".pdf" required>
                    </div>
                    <div id="fileName" class="file-name">æœªé€‰æ‹©æ–‡ä»¶</div>
                </div>
                
                <div class="form-group">
                    <label for="pdfPassword">PDFå¯†ç ï¼ˆå¦‚æœ‰ï¼‰</label>
                    <input type="password" id="pdfPassword" name="password" placeholder="ç•™ç©ºè¡¨ç¤ºæ— å¯†ç ">
                </div>
                
                <div class="form-group">
                    <label for="pdfTitle">æ–‡æ¡£æ ‡é¢˜</label>
                    <input type="text" id="pdfTitle" name="title" placeholder="è¾“å…¥æ–‡æ¡£æ ‡é¢˜">
                </div>
                
                <div class="form-group">
                    <label for="pdfAuthor">ä½œè€…</label>
                    <input type="text" id="pdfAuthor" name="author" placeholder="è¾“å…¥ä½œè€…åç§°">
                </div>
                
                <div class="form-group">
                    <label for="pdfCategory">åˆ†ç±»</label>
                    <input type="text" id="pdfCategory" name="category" placeholder="è¾“å…¥æ–‡æ¡£åˆ†ç±»">
                </div>
                
                <button type="submit" class="upload-btn">ä¸Šä¼ å¹¶å¯¼å…¥çŸ¥è¯†åº“</button>
            </form>
            
            <div id="uploadStatus" class="upload-status"></div>
        </div>
        
        <div class="section">
            <div class="section-title">å·²å¯¼å…¥æ–‡æ¡£</div>
            <div id="documentList" class="document-list">
                <p>æ­£åœ¨åŠ è½½æ–‡æ¡£åˆ—è¡¨...</p>
            </div>
        </div>
        
        <a href="/" class="back-btn">è¿”å›ä¸»é¡µ</a>
    </div>
    
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // è¿æ¥çŠ¶æ€æ˜¾ç¤º
            const connectionStatus = document.getElementById('connectionStatus');
            connectionStatus.textContent = 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...';
            
            // è·å–çŸ¥è¯†åº“ç»Ÿè®¡ä¿¡æ¯
            fetchKnowledgeStats();
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            const fileInput = document.getElementById('pdfFile');
            const fileNameDisplay = document.getElementById('fileName');
            
            fileInput.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    fileNameDisplay.textContent = this.files[0].name;
                } else {
                    fileNameDisplay.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                }
            });
            
            // è¡¨å•æäº¤å¤„ç†
            const uploadForm = document.getElementById('pdfUploadForm');
            const uploadStatus = document.getElementById('uploadStatus');
            
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
                uploadStatus.textContent = 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶ï¼Œè¯·ç¨å€™...';
                uploadStatus.className = 'upload-status';
                uploadStatus.style.display = 'block';
                
                // åˆ›å»ºFormDataå¯¹è±¡
                const formData = new FormData();
                
                // æ·»åŠ æ–‡ä»¶
                const fileInput = document.getElementById('pdfFile');
                if (fileInput.files.length > 0) {
                    formData.append('file', fileInput.files[0]);
                } else {
                    uploadStatus.textContent = 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„PDFæ–‡ä»¶';
                    uploadStatus.className = 'upload-status error';
                    return;
                }
                
                // æ·»åŠ å…¶ä»–è¡¨å•å­—æ®µ
                const password = document.getElementById('pdfPassword').value;
                const title = document.getElementById('pdfTitle').value;
                const author = document.getElementById('pdfAuthor').value;
                const category = document.getElementById('pdfCategory').value;
                
                if (password) formData.append('password', password);
                if (title) formData.append('title', title);
                if (author) formData.append('author', author);
                if (category) formData.append('category', category);
                
                // å‘é€ä¸Šä¼ è¯·æ±‚
                fetch('/api/knowledge/upload_pdf', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        uploadStatus.textContent = data.message;
                        uploadStatus.className = 'upload-status success';
                        
                        // é‡æ–°è·å–çŸ¥è¯†åº“ç»Ÿè®¡ä¿¡æ¯
                        fetchKnowledgeStats();
                        
                        // é‡ç½®è¡¨å•
                        uploadForm.reset();
                        fileNameDisplay.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                    } else {
                        uploadStatus.textContent = 'ä¸Šä¼ å¤±è´¥: ' + data.message;
                        uploadStatus.className = 'upload-status error';
                    }
                })
                .catch(error => {
                    console.error('ä¸Šä¼ é”™è¯¯:', error);
                    uploadStatus.textContent = 'ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message;
                    uploadStatus.className = 'upload-status error';
                });
            });
            
            // æ›´æ–°è¿æ¥çŠ¶æ€
            connectionStatus.textContent = 'å·²è¿æ¥åˆ°æœåŠ¡å™¨';
            connectionStatus.className = 'connection-status connected';
        });
        
        // è·å–çŸ¥è¯†åº“ç»Ÿè®¡ä¿¡æ¯
        function fetchKnowledgeStats() {
            const statsContainer = document.getElementById('knowledgeStats');
            statsContainer.innerHTML = '<div class="stats-item">æ­£åœ¨åŠ è½½ç»Ÿè®¡ä¿¡æ¯...</div>';
            
            fetch('/api/knowledge/knowledge_stats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const stats = data.stats;
                        
                        let statsHTML = '';
                        statsHTML += '<div class="stats-item"><strong>æ–‡æ¡£æ€»æ•°:</strong> ' + (stats.total_documents || 0) + '</div>';
                        statsHTML += '<div class="stats-item"><strong>æ–‡æœ¬å—æ€»æ•°:</strong> ' + (stats.total_chunks || 0) + '</div>';
                        statsHTML += '<div class="stats-item"><strong>çŸ¥è¯†åº“å¤§å°:</strong> ' + formatBytes(stats.index_size || 0) + '</div>';
                        statsHTML += '<div class="stats-item"><strong>æœ€åæ›´æ–°æ—¶é—´:</strong> ' + (stats.last_updated || 'æœªçŸ¥') + '</div>';
                        
                        if (stats.categories && stats.categories.length > 0) {
                            statsHTML += '<div class="stats-item"><strong>æ–‡æ¡£åˆ†ç±»:</strong> ' + stats.categories.join(', ') + '</div>';
                        } else {
                            statsHTML += '<div class="stats-item"><strong>æ–‡æ¡£åˆ†ç±»:</strong> æ— åˆ†ç±»</div>';
                        }
                        
                        statsContainer.innerHTML = statsHTML;
                        
                        // æ›´æ–°æ–‡æ¡£åˆ—è¡¨
                        updateDocumentList(stats.documents || []);
                    } else {
                        statsContainer.innerHTML = '<div class="stats-item">è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                    }
                })
                .catch(error => {
                    console.error('è·å–çŸ¥è¯†åº“ç»Ÿè®¡å¤±è´¥:', error);
                    statsContainer.innerHTML = '<div class="stats-item">è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ' + error.message + '</div>';
                });
        }
        
        // æ›´æ–°æ–‡æ¡£åˆ—è¡¨
        function updateDocumentList(documents) {
            const documentList = document.getElementById('documentList');
            
            if (!documents || documents.length === 0) {
                documentList.innerHTML = '<p>æš‚æ— å¯¼å…¥çš„æ–‡æ¡£</p>';
                return;
            }
            
            let html = '';
            documents.forEach(doc => {
                html += '<div class="document-item">';
                html += '<div class="document-title">' + (doc.title || 'æœªå‘½åæ–‡æ¡£') + '</div>';
                html += '<div class="document-meta">';
                
                if (doc.author) {
                    html += '<span>ä½œè€…: ' + doc.author + '</span> | ';
                }
                
                if (doc.category) {
                    html += '<span>åˆ†ç±»: ' + doc.category + '</span> | ';
                }
                
                html += '<span>æ–‡æœ¬å—æ•°é‡: ' + (doc.chunk_count || 0) + '</span>';
                html += '</div>';
                html += '</div>';
            });
            
            documentList.innerHTML = html;
        }
        
        // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
        function formatBytes(bytes, decimals) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals || 2;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>